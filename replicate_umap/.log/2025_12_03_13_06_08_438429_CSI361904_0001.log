***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:08,439
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/venv/lib/python3.12/site-packages/sitecustomize.py
LINENO: 85
MESSAGE: 

Initialized python call.
FILENAME: /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/normalize_twotime_contrast.py
COMMIT: 895ac536b3dde1823b2698b662cf5e18d6753e69
ARGV: ['--quick-test', '--half-window-lengths', '6', '--window-stepsize-ratios', '2']
REQUIREMENTS:
contourpy==1.3.3    
cycler==0.12.1    
filelock==3.20.0    
fonttools==4.60.1    
fsspec==2025.10.0    
ImageIO==2.37.2    
imageio-ffmpeg==0.6.0    
Jinja2==3.1.6    
joblib==1.5.2    
kiwisolver==1.4.9    
llvmlite==0.45.1    
MarkupSafe==3.0.3    
matplotlib==3.10.7    
mpmath==1.3.0    
networkx==3.5    
numba==0.62.1    
numpy==1.26.4    
packaging==25.0    
pandas==2.3.3    
pillow==12.0.0    
pip==25.0.1    
psutil==7.1.3    
pynndescent==0.5.13    
pyparsing==3.2.5    
python-dateutil==2.9.0.post0    
pytz==2025.2    
scikit-learn==1.7.2    
scipy==1.16.3    
seaborn==0.13.2    
six==1.17.0    
sympy==1.14.0    
threadpoolctl==3.6.0    
torch==2.2.2    
torchvision==0.17.2    
tqdm==4.67.1    
typing_extensions==4.15.0    
tzdata==2025.2    
umap-learn==0.5.9.post2    
-e git+ssh://git@github.com/bfichera/umap_cdw.git@895ac536b3dde1823b2698b662cf5e18d6753e69#egg=umap_cdw    
-e git+ssh://git@github.com/bfichera/UMAP_RGB.git@45b895a46447a570ee127c7f89a24924773b7fe6#egg=UMAP_RGB    
workflowrecorder @ git+ssh://git@github.com/bfichera/workflowrecorder.git@2fe61687c3987bdc8a156fecff1d60dcd220e2f4
FILE CONTENTS:
import logging
import sys
import time
import argparse
from pathlib import Path
import itertools

import numpy as np
import torch
from numba import config
from workflowrecorder import Recorder
from UMAP_RGB.utils.window import WindowMesh
from UMAP_RGB.networks.EfficientNet_model import EfficientEncoder
from UMAP_RGB.utils.PCA_RGB import PCA

from umap_cdw import load


def normalize_contrast(im):
    mini = np.amin(im, axis=(-1, -2), keepdims=True)
    maxi = np.amax(im, axis=(-1, -2), keepdims=True)
    return (im - mini) / (maxi - mini)


parser = argparse.ArgumentParser()
parser.add_argument('--quick-test', action='store_true')
parser.add_argument('--half-window-lengths', type=int, nargs='+')
parser.add_argument('--window-stepsize-ratios', type=int, nargs='+')

_cfg = parser.parse_args()
quick_test = _cfg.quick_test
window_lengths = [c * 2 for c in _cfg.half_window_lengths]
window_stepsize_ratios = _cfg.window_stepsize_ratios

start_time = time.time()

logger = logging.getLogger()
logger.addHandler(logging.StreamHandler(sys.stderr))
logger.setLevel(logging.INFO)

logger.info(f"Numba thread layer: {config.THREADING_LAYER}")
logger.info(f"Numba threads: {config.NUMBA_NUM_THREADS}")
logger.info(f"PyTorch intra-op threads: {torch.get_num_threads()}")
logger.info(f"PyTorch inter-op threads: {torch.get_num_interop_threads()}")

results_path = Path.cwd() / 'results'
if not results_path.exists():
    results_path.mkdir(parents=True, exist_ok=True)
for window_length, window_stepsize_ratio in itertools.product(
        window_lengths, window_stepsize_ratios):
    iteration_start_time = time.time()
    with Recorder(
            f'test2_results_{window_length:03d}_{window_stepsize_ratio:03d}',
            results_path / f'test2_results_{window_length:03d}'
            f'_{window_stepsize_ratio:03d}.pkl',
    ) as recorder:
        img_stk = load('test2_*.bin', (2, 256, 256))
        recorder.register(img_stk)
        if quick_test:
            logger.warning('Using wrong size data!')
            mapper_in = img_stk[:20, -1, ::4, ::4]
        else:
            mapper_in = img_stk[:, -1, :, :]
        recorder.register(mapper_in)
        window_shape = (mapper_in.shape[0], window_length, window_length)
        recorder.register(window_shape)
        step_shape = (
            mapper_in.shape[0], window_length // window_stepsize_ratio,
            window_length // window_stepsize_ratio
        )
        recorder.register(step_shape)
        windows = WindowMesh(mapper_in, window_shape, step_shape)

        model = EfficientEncoder(windows, mapper_in)
        windows._window_processor()
        windows._window_ttcf = normalize_contrast(
            windows.window_ttcf
        )
        low_res_feature_map, upscaler = model.extract_embedding(
            full_output=False
        )

        recorder.register(windows.window_ttcf, name='window_ttcf')

        mapper = PCA(low_res_feature_map, upscaler)
        mapper.generate_rgb(sparsity_mult=20)

        recorder.register(
            mapper.rgb[0],
            name='mapper_get_rgb_0',
            description='mapper.rgb[0]',
        )
        recorder.register(
            mapper.rgb,
            name='mapper_rgb',
            description='mapper.rgb',
        )
        recorder.register(
            mapper.low_res_rgb,
            name='mapper_low_res_rgb',
            description='mapper.low_res_rgb',
        )

    logger.info(
        'Single window length / stepsize combination finished after '
        f'{time.time() - iteration_start_time} seconds.'
    )

logger.info(
    f'Entire script finished after {time.time() - start_time} seconds.'
)

***END RECORD***

***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:12,198
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/normalize_twotime_contrast.py
LINENO: 41
MESSAGE: 
Numba thread layer: workqueue
***END RECORD***

***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:12,199
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/normalize_twotime_contrast.py
LINENO: 42
MESSAGE: 
Numba threads: 1
***END RECORD***

***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:12,199
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/normalize_twotime_contrast.py
LINENO: 43
MESSAGE: 
PyTorch intra-op threads: 1
***END RECORD***

***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:12,199
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/normalize_twotime_contrast.py
LINENO: 44
MESSAGE: 
PyTorch inter-op threads: 16
***END RECORD***

***START RECORD***
LEVEL: WARNING
DATETIME: 2025-12-03 13:06:12,426
NAME: /Users/bfichera/data/projects/umap_cdw/umap_cdw/data.py
PATH: /Users/bfichera/data/projects/umap_cdw/umap_cdw/data.py
LINENO: 32
MESSAGE: 
File could not be loaded: test2_alpha.bin
***END RECORD***

***START RECORD***
LEVEL: WARNING
DATETIME: 2025-12-03 13:06:12,426
NAME: /Users/bfichera/data/projects/umap_cdw/umap_cdw/data.py
PATH: /Users/bfichera/data/projects/umap_cdw/umap_cdw/data.py
LINENO: 33
MESSAGE: 
Expected shape (2, 256, 256), got (1, 256, 256)
***END RECORD***

***START RECORD***
LEVEL: WARNING
DATETIME: 2025-12-03 13:06:12,605
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/normalize_twotime_contrast.py
LINENO: 60
MESSAGE: 
Using wrong size data!
***END RECORD***

***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:17,563
NAME: workflowrecorder.recorder
PATH: /Users/bfichera/data/projects/umap_cdw/venv/lib/python3.12/site-packages/workflowrecorder/recorder.py
LINENO: 174
MESSAGE: 
Record created at /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/results/test2_results_012_002.pkl
***END RECORD***

***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:17,564
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/normalize_twotime_contrast.py
LINENO: 104
MESSAGE: 
Single window length / stepsize combination finished after 5.364691972732544 seconds.
***END RECORD***

***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:17,564
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/normalize_twotime_contrast/normalize_twotime_contrast.py
LINENO: 109
MESSAGE: 
Entire script finished after 5.365299224853516 seconds.
***END RECORD***

***START RECORD***
LEVEL: INFO
DATETIME: 2025-12-03 13:06:47,272
NAME: root
PATH: /Users/bfichera/data/projects/umap_cdw/venv/lib/python3.12/site-packages/sitecustomize.py
LINENO: 88
MESSAGE: 
Exiting
***END RECORD***

